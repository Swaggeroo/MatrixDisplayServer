import express from "express";
import fs from "fs";
import config from "config";
import path from "path";
import { PNG } from 'pngjs';
const router = express.Router();
const debugApplyImage = require('debug')('app:applyImage');

const IMAGE_DIR: string = config.get('imageDir');
const WLED_URL: string = config.get('wledUrl');
const HEIGHT: number = config.get('height');
const WIDTH: number = config.get('width');
const INCREMENT: number = WIDTH*HEIGHT/4;
const BRIGHTNESS: number = 20;

router.post('/apply/:uuid', (req, res) => {
    const uuid = req.params.uuid;
    let brightness: number = Number(req.query.brightness);
    if (isNaN(brightness)) {
        brightness = BRIGHTNESS;
    }

    if (brightness < 15) {
        brightness = 15;
    }

    if (brightness > 255) {
        brightness = 255;
    }

    const file = path.resolve(`${IMAGE_DIR}/${uuid}.png`);

    if (!fs.existsSync(file)) {
        return res.status(404).send('The image with the given UUID was not found.');
    }

    // Read the image file into a Buffer
    const imageData = fs.readFileSync(file);

    // Parse the image buffer
    const png = PNG.sync.read(imageData);

    // Get the pixels
    const pixels = [];
    for (let y = 0; y < png.height; y++) {
        for (let x = 0; x < png.width; x++) {
            const idx = (png.width * y + x) << 2;
            const pixel = {
                red: png.data[idx],
                green: png.data[idx + 1],
                blue: png.data[idx + 2],
                alpha: png.data[idx + 3]
            };
            pixels.push(pixel);
        }
    }

    let requests = [];

    for (let i = 0; i < 4; i++) {
        let jsonString = '{"on":true,"bri":'+brightness+',"seg":{"i":[]}}';
        let jsonObject = JSON.parse(jsonString);

        jsonObject.seg.i.push(INCREMENT*i);

        for (let j = INCREMENT*i; j < INCREMENT*(i+1); j++) {
            if (pixels[j].alpha === 0) {
                jsonObject.seg.i.push("000000");
            }else {
                jsonObject.seg.i.push(pixels[j].red.toString(16).padStart(2, '0') + pixels[j].green.toString(16).padStart(2, '0') + pixels[j].blue.toString(16).padStart(2, '0'));
            }
        }

        requests.push(sendToWLED(JSON.stringify(jsonObject)));
    }

    Promise.all(requests).then(() => {
        debugApplyImage('Image applied: ' + uuid);
        res.send('The image was applied.');
    }).catch(error => {
        debugApplyImage('Failed to apply image: ' + uuid + ' - ' + error);
        res.status(500).send('Failed to apply the image.');
    });

    //let jsonString2 = "{\"on\":true,\"bri\":128,\"seg\":{\"id\":0,\"i\":[0,66,\"f8f8f8\",\"dbdbda\",\"a9a7a4\",\"a7a6a3\",\"a6a5a3\",70,74,\"a5a4a2\",\"a5a4a1\",\"a8a6a4\",\"a8a7a4\",77,79,\"a9a7a5\",\"a9a7a4\",80,85,\"a5a4a2\",\"a7a5a3\",\"a7a6a4\",\"a9a7a5\",\"a7a5a3\",\"a5a4a2\",\"a8a7a4\",91,93,\"a9a7a5\",\"dcdbdb\",94,98,\"f8f8f8\",\"a8a7a5\",99,101,\"17120a\",\"16120a\",\"120f07\",\"110d07\",\"0e0b05\",\"120d07\",\"130e06\",\"1b140b\",\"1c140c\",\"1d160d\",\"1d150d\",\"1c150d\",112,115,\"140e08\",\"140e07\",\"140e08\",\"17110a\",\"16110a\",\"18130b\",\"141009\",\"130f07\",\"1c160d\",\"1c170d\",\"17120c\",\"a9a6a5\",126,130,\"f8f8f8\",\"a9a7a5\",\"1d180e\",\"97784c\",\"a38052\",\"a38051\",\"675133\",\"271f11\",\"875837\",\"9d653e\",\"9c653d\",\"9d663e\",\"a16942\",\"9f6840\",\"9e6740\",\"9f6841\",\"9f6741\",146,148,\"9f6740\",\"9e6740\",\"9d653f\",\"885936\",\"271f11\",\"675334\",\"a58254\",\"a48152\",\"98794c\",\"1c170d\",\"a9a6a5\",158,162,\"f8f8f8\",\"a8a6a4\",\"1c160c\",\"a48152\",\"ac8856\",\"95774a\",\"6b5334\",\"3d2c1a\",\"94613b\",170,172,\"a76c42\",\"a66c41\",173,175,\"a86d43\",\"a76d43\",\"a97045\",\"a96f45\",178,180,\"aa6f45\",\"a96f45\",\"a86d43\",\"93603b\",\"342716\",\"6d5735\",\"a38252\",\"ae8958\",\"a38051\",\"1c160e\",\"a9a6a4\",190,194,\"f8f8f8\",\"a5a4a2\",\"120f07\",\"a38051\",\"a18050\",\"241c11\",\"5b3f24\",200,203,\"a0673c\",\"a0683c\",\"975d35\",\"874a2b\",\"8f532e\",\"945931\",\"9f663b\",209,211,\"a0673c\",211,213,\"9e653a\",213,215,\"9f663b\",\"a2693e\",\"5e4025\",\"251c11\",\"9f7f4d\",\"a17f4d\",\"130f08\",\"a5a4a2\",222,226,\"f8f8f8\",\"a7a6a4\",\"15110a\",\"675233\",\"6c5634\",\"5b3e24\",\"6a4629\",\"794f30\",\"794e2f\",\"784e2e\",\"754929\",\"704426\",\"683b20\",\"704326\",\"734729\",\"7a512f\",\"7a502f\",\"794e2f\",\"784e2e\",\"774e2e\",245,247,\"784e2e\",\"794f2f\",\"694629\",\"5b3e23\",\"6b5533\",\"665132\",\"141009\",\"a6a5a3\",254,258,\"f8f8f8\",\"a9a7a5\",\"18140c\",\"271f13\",\"332716\",\"a0673b\",\"794f2f\",\"533722\",\"503620\",\"50351f\",\"492815\",\"482815\",\"4a2b17\",\"4f331d\",\"513620\",\"543923\",\"543722\",\"513520\",\"513621\",276,278,\"523621\",\"513621\",\"513520\",\"774d2e\",\"9f663b\",\"332815\",\"271f11\",\"18130b\",\"a9a6a5\",286,290,\"f8f8f8\",\"a8a7a5\",\"1c150c\",\"96623d\",\"a16941\",\"a36a3e\",\"7b5030\",\"503520\",\"894d2d\",\"94542f\",\"945430\",\"704226\",\"4e321d\",\"8b5a37\",\"a46b42\",\"a46b43\",\"8a5a38\",\"4f341e\",\"815434\",\"99643e\",\"8d512d\",\"804929\",\"4a2d19\",\"764b2b\",\"a0663c\",\"94613c\",\"895b37\",\"1c150d\",\"a9a6a5\",318,322,\"f8f8f8\",\"a6a4a3\",\"150f08\",\"9e6740\",\"a96e44\",\"a2693e\",\"7a5030\",\"503520\",\"8d502d\",\"9a572f\",\"9a5831\",\"724427\",\"4d321d\",\"8e5c38\",335,337,\"aa6f45\",\"8f5d39\",\"4e331d\",\"8c5a37\",\"a96e44\",\"9a5730\",\"8b4f2b\",\"4a2b17\",\"754a29\",\"9f663b\",\"a86f44\",\"9f6740\",\"1d150e\",\"a9a6a5\",350,354,\"f8f8f8\",\"a5a4a2\",\"130e08\",\"a06842\",\"aa7046\",\"a0673c\",\"75492a\",\"492915\",\"98623c\",\"aa6e43\",\"a0673c\",\"714929\",\"482e18\",\"865631\",\"a0673d\",\"a1673c\",\"865731\",\"492e19\",\"835431\",\"a0673c\",\"9e5b33\",\"90542f\",\"513520\",\"764c2c\",\"9b6237\",\"a86e44\",\"9f6840\",\"1e150e\",\"a9a6a5\",382,386,\"f8f8f8\",\"a5a4a2\",\"130e07\",\"9d653e\",\"a76d43\",\"a0673c\",\"764b2b\",\"4d2e1a\",\"734a2b\",\"7b4f2f\",\"734a2a\",\"5e3d22\",\"4c321c\",\"6a4528\",399,401,\"764d2d\",\"6a4528\",\"4c311c\",\"633e22\",\"6e4426\",\"754526\",\"6e4225\",\"513621\",\"764e2c\",\"9c6338\",\"a86e44\",\"9f6740\",\"19130b\",\"a7a6a4\",414,418,\"f8f8f8\",\"a5a4a2\",\"130d06\",\"9a633c\",\"a56a40\",\"a0673c\",\"784f2f\",\"523621\",\"4f331e\",\"4e321d\",\"49301a\",\"4d321d\",\"523722\",430,432,\"513521\",432,434,\"513621\",\"513520\",\"452918\",\"412616\",\"4e321e\",\"4f331e\",\"523722\",\"77502e\",\"a0673c\",\"a86f44\",\"9e6740\",\"130e07\",\"a5a4a2\",446,450,\"f8f8f8\",\"a7a5a4\",\"1a140b\",\"9b643c\",\"a56a40\",\"a0673c\",\"784f2f\",\"503620\",\"8a5937\",\"8e5c38\",\"865731\",\"694529\",\"513621\",\"7d5132\",\"915e3a\",\"905e3a\",\"7d5132\",\"523420\",\"6a3e23\",\"774426\",\"8e5b38\",\"845535\",\"513621\",\"774f2e\",\"9e653a\",\"a86e44\",\"9e6740\",\"130e08\",\"a5a4a2\",478,482,\"f8f8f8\",\"a8a6a4\",\"1c150c\",\"9b643d\",\"a56a40\",\"9f663b\",\"784f2e\",\"503620\",\"a36a42\",\"a86d43\",\"9e643a\",\"744b2c\",\"503520\",\"8f5e39\",495,497,\"ab7046\",\"905e39\",\"50331e\",\"7a4829\",\"8f542f\",\"a86d43\",\"99643e\",\"503520\",\"774e2d\",\"9e653a\",\"a86d43\",\"9e663f\",\"130e08\",\"a5a4a2\",510,514,\"f8f8f8\",\"a7a5a3\",\"1b150b\",\"9f6740\",\"a96e44\",\"9d6438\",\"774d2d\",\"503620\",\"a46b43\",\"a86d42\",\"8b4e2b\",\"683b20\",\"492b17\",\"8d5a37\",527,529,\"ab7046\",\"8e5c38\",\"4a2c17\",\"83532f\",\"9f663c\",\"a86f44\",\"98633d\",\"4a2b17\",\"784d2c\",\"a56c41\",\"a66b41\",\"9a633c\",\"130d07\",\"a5a4a2\",542,546,\"f8f8f8\",\"a5a4a2\",\"130e07\",\"9f673f\",\"a96e44\",\"9e6539\",\"784e2d\",\"503620\",\"8b5a37\",\"8e5c37\",\"754124\",\"5e361e\",\"4b2e19\",\"7c4f30\",559,561,\"905e3a\",\"7c5030\",\"4c2e1a\",\"734929\",\"865732\",\"8d5a36\",\"815231\",\"4a2a16\",\"774c2b\",\"a36a40\",\"a66c42\",\"9b633d\",\"151009\",\"a6a4a3\",574,578,\"f8f8f8\",\"a5a4a2\",\"130e08\",\"9e6740\",\"aa6e45\",\"a1683d\",\"794f30\",\"523721\",\"4f321e\",\"4e311e\",\"412216\",\"482c1a\",589,591,\"513621\",\"513620\",\"523421\",\"513420\",\"513621\",\"4b301b\",\"492f19\",\"482816\",598,600,\"492815\",\"744928\",\"a0673c\",\"a66d42\",\"9d663e\",\"1d150d\",\"a9a6a5\",606,610,\"f8f8f8\",\"a5a4a2\",\"130e07\",\"9a623b\",\"a56a40\",\"a0673c\",\"794f2f\",\"523521\",\"7d492b\",\"814a2a\",\"80502e\",\"644024\",\"4b311b\",\"734b2b\",\"845631\",\"865733\",\"754c2c\",\"4b311b\",\"673c22\",\"754225\",\"7e4728\",\"764325\",\"4e311d\",\"764d2c\",\"a0673d\",\"a76e43\",\"9e673e\",\"1d160e\",\"a9a6a5\",638,642,\"f8f8f8\",\"a5a4a2\",\"130d07\",\"99613b\",\"a3693f\",\"a0673c\",\"7a4f2f\",\"523620\",\"965531\",\"9a5932\",\"a0673c\",\"734a2a\",\"492f19\",\"845731\",\"9c673b\",\"a1683d\",\"875732\",\"492f1a\",\"754225\",\"8a4d2b\",\"9a5632\",\"8d512e\",\"513622\",\"77502e\",\"a0673d\",\"a86f44\",\"9f6740\",\"1c160d\",\"a9a6a4\",670,674,\"f8f8f8\",\"a7a5a3\",\"171008\",\"9e663f\",\"a86d42\",\"9f6a3e\",\"7a5030\",\"503520\",\"a56c44\",\"ac7046\",\"ac7147\",\"7c5130\",\"4f321e\",\"8f5c38\",\"a96e44\",\"a66b41\",\"8a5734\",\"472816\",\"7e4627\",\"9a5732\",\"aa6e44\",\"9a643e\",\"503520\",\"78502e\",\"a0673d\",\"a86f44\",\"9e6740\",\"130e08\",\"a5a4a2\",702,706,\"f8f8f8\",\"a8a6a4\",\"19130b\",\"895a38\",\"95623c\",\"a06a3e\",\"7a5030\",\"513520\",\"98633f\",\"9c6741\",\"9c6740\",\"744c2d\",\"4f331f\",\"835634\",\"99633e\",\"96613b\",\"7f5030\",\"482a18\",\"764426\",\"8e512e\",\"9a653f\",\"8d5d3a\",\"503520\",\"77502e\",\"a0673c\",\"94613b\",\"885937\",\"140e08\",\"a5a4a3\",734,738,\"f8f8f8\",\"a5a4a2\",\"0e0c06\",\"261f11\",\"3f2e1b\",\"a56c41\",\"7c5231\",744,746,\"523621\",746,754,\"513621\",\"513520\",\"50341f\",\"503520\",757,760,\"513621\",\"784f2e\",\"a0673c\",\"332818\",\"251e14\",\"19140d\",\"a9a7a5\",766,770,\"f8f8f8\",\"a5a4a2\",\"120e07\",\"836841\",\"856842\",\"5f4227\",\"6b4829\",\"794e2e\",777,779,\"7a5030\",\"784f2e\",780,782,\"784e2e\",\"774e2d\",\"784d2d\",\"784f2e\",785,787,\"784e2e\",\"774d2d\",\"774e2d\",\"784e2e\",790,792,\"794f2e\",\"6a472a\",\"5d4025\",\"6f5939\",\"604e31\",\"17120b\",\"a8a6a5\",798,802,\"f8f8f8\",\"a5a4a2\",\"120f07\",\"a38052\",\"96774a\",\"251e11\",\"5c3f25\",\"a0673c\",809,811,\"a36a3f\",\"a0673c\",812,814,\"9f663b\",\"9e653a\",\"9e643a\",816,819,\"a0673c\",819,821,\"9e653a\",\"9f663b\",822,824,\"a0673c\",\"5d4025\",\"251e13\",\"a78655\",\"97794f\",\"18130b\",\"a8a6a5\",830,834,\"f8f8f8\",\"a5a4a2\",\"120f07\",\"a48052\",\"ac8955\",\"a0804d\",\"6b5534\",\"332716\",\"a16a41\",842,848,\"aa6f45\",\"a96f44\",849,854,\"aa6f45\",\"94613c\",\"332715\",\"876d45\",\"a28150\",\"af8a59\",\"93744b\",\"19140c\",\"a9a7a5\",862,866,\"f8f8f8\",\"a5a4a2\",\"130e07\",\"886b44\",\"91734a\",\"8f7146\",\"5c482c\",\"231c11\",\"95623c\",\"9f673f\",875,878,\"9f6740\",\"a06941\",\"a06942\",\"9e6840\",\"9f6840\",\"9f6641\",883,885,\"9f6740\",\"9f673f\",\"895b36\",\"271f11\",\"846941\",\"a58253\",\"a48151\",\"886c45\",\"1a140d\",\"a9a7a5\",894,898,\"f8f8f8\",\"a8a7a5\",\"18120b\",\"18130b\",\"15110a\",\"0d0b05\",\"0d0a05\",\"0c0905\",\"1a140b\",\"1b150c\",\"1c150d\",908,910,\"1d150e\",\"1d150d\",\"1d160d\",\"201810\",\"1c150d\",\"130d07\",\"19130b\",916,918,\"1d150e\",\"19130b\",\"0e0b06\",\"18140b\",\"1d180e\",\"1c160d\",\"1b150c\",\"19130e\",\"a9a7a5\",926,930,\"f8f8f8\",\"dbdbda\",\"a9a6a5\",\"a9a6a4\",\"a7a6a4\",934,936,\"a5a4a2\",\"a5a4a3\",937,939,\"a8a6a4\",\"a9a6a4\",940,944,\"a9a6a5\",\"aaa8a6\",\"a8a7a5\",\"a5a4a2\",\"a7a5a4\",948,950,\"a9a6a5\",\"a8a6a4\",\"a5a4a2\",\"a7a5a4\",\"a9a6a5\",954,956,\"a8a6a4\",\"a9a7a5\",\"dcdbda\",958,1024,\"f8f8f8\"]}}"

 });

async function sendToWLED(jsonString: string) {
    return fetch(WLED_URL + '/json/state', {
        method: 'POST',
        body: jsonString,
        headers: {'Content-Type': 'application/json'}
    });
}

module.exports = router;